<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Xs的工具箱 - Veo 3.1 Pro</title>
    <link rel="icon" href="kitty.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; transition: background-color 0.3s, color 0.3s; }
        .custom-input { transition: all 0.2s; }
        .custom-input:focus { border-color: #8b5cf6; outline: none; box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2); }
        .dropdown-arrow { transition: transform 0.3s ease; }
        .dropdown-open .dropdown-arrow { transform: rotate(180deg); }
        .glow-effect { box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.5); border-color: #8b5cf6 !important; color: #8b5cf6 !important; }
        .resizer-x { width: 6px; cursor: col-resize; background-color: #f3f4f6; border-left: 1px solid #e5e7eb; border-right: 1px solid #e5e7eb; z-index: 50; transition: background-color 0.2s; }
        .dark .resizer-x { background-color: #18181b; border-color: #27272a; }
        .resizer-x:hover, .resizer-x.active { background-color: #8b5cf6; }
        .resizer-y { height: 8px; cursor: row-resize; background-color: #f3f4f6; border-top: 1px solid #e5e7eb; border-bottom: 1px solid #e5e7eb; z-index: 50; transition: background-color 0.2s; }
        .dark .resizer-y { background-color: #18181b; border-color: #27272a; }
        .resizer-y:hover, .resizer-y.active { background-color: #8b5cf6; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #52525b; border-radius: 3px; }
        .no-select { user-select: none !important; -webkit-user-select: none !important; }
        .prompt-box { background-color: #f9fafb; border-radius: 8px; padding: 12px; font-size: 13px; color: #374151; line-height: 1.6; }
        .dark .prompt-box { background-color: #18181b; color: #d1d5db; }
        .task-item.selected { background-color: rgba(139, 92, 246, 0.05); border-left-color: #8b5cf6; }
        @media (max-width: 768px) {
            .resizer-x, .resizer-y { display: none !important; }
            #main-container { flex-direction: column !important; height: auto !important; overflow: visible !important; }
            #left-panel { width: 100% !important; height: auto !important; border-right: none; border-bottom: 1px solid #e5e7eb; }
            #preview-section { height: auto !important; min-height: 500px !important; flex-direction: column !important; }
            #list-section { height: 600px !important; flex: none !important; }
            #detail-panel { width: 100% !important; border-left: none !important; border-top: 1px solid #e5e7eb; }
        }
    </style>
</head>
<body class="md:h-screen flex flex-col md:overflow-hidden bg-gray-50 text-gray-800 dark:bg-[#09090b] dark:text-[#e4e4e7]" onload="initApp()" onclick="closeDropdownOnClickOutside(event)">

    <header class="h-14 border-b border-gray-200 dark:border-[#27272a] bg-white dark:bg-[#09090b] flex items-center justify-between px-4 shrink-0 z-50 sticky top-0">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded-lg overflow-hidden border border-gray-200 shadow-sm shrink-0">
                <img src="veo3.1.png" class="w-full h-full object-cover" alt="Logo">
            </div>
            <span class="font-bold text-lg tracking-tight text-gray-900 dark:text-gray-100">Veo 3.1</span>
        </div>
        <div class="flex items-center gap-3 text-sm">
            <div class="hidden md:flex items-center gap-2 px-3 py-1 bg-gray-100 dark:bg-[#18181b] border border-gray-200 dark:border-[#27272a] rounded-full text-[10px] font-mono text-gray-500 dark:text-gray-400 select-none mr-2">
                <div class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></div>
                <span id="current-api-display">检测中...</span>
            </div>
            <button onclick="toggleTheme()" class="w-9 h-9 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-100 dark:hover:bg-[#18181b] transition"><i id="theme-icon" class="fa-solid fa-moon"></i></button>
            <button onclick="openSettings()" class="w-9 h-9 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-100 dark:hover:bg-[#18181b] transition"><i class="fa-solid fa-gear"></i></button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden relative" id="main-container">
        <aside id="left-panel" class="w-full md:w-[350px] bg-white border-r border-gray-200 dark:bg-[#0c0c0e] dark:border-[#27272a] flex flex-col shrink-0 z-10 transition-colors md:overflow-y-auto">
            <div class="p-5 space-y-5">
                <div class="flex items-center justify-between relative z-50">
                    <label class="text-xs font-bold uppercase text-black-500">选择模型</label>
                    <div class="relative w-48" id="custom-model-dropdown">
                        <input type="hidden" id="model-input" value="veo3.1">
                        <div onclick="toggleDropdown(event, 'custom-model-dropdown', 'model-options', 'model-trigger')" id="model-trigger" class="w-full flex justify-between items-center bg-gray-50 dark:bg-[#18181b] border border-gray-200 dark:border-[#27272a] rounded-lg px-3 py-1.5 cursor-pointer hover:bg-gray-100 dark:hover:bg-[#27272a]">
                            <span id="current-model-text" class="text-xs font-bold font-mono text-black dark:text-white">veo3.1</span>
                            <i class="fa-solid fa-chevron-down text-[10px] text-gray-500 dropdown-arrow"></i>
                        </div>
                        <div id="model-options" class="hidden absolute top-full right-0 mt-2 w-full bg-white dark:bg-[#18181b] border border-gray-200 dark:border-[#27272a] rounded-xl shadow-xl z-50 p-1">
                            <div onclick="selectModel('veo3.1', 'veo3.1')" class="model-option flex justify-between items-center px-3 py-2 rounded-lg cursor-pointer hover:bg-violet-50 dark:hover:bg-[#27272a] group bg-violet-50 dark:bg-[#27272a]" data-val="veo3.1">
                                <span class="text-xs font-bold">veo3.1</span>
                                <i class="fa-solid fa-check text-violet-500 text-xs opacity-100 check-icon"></i>
                            </div>
                            <div onclick="selectModel('veo3.1-components', 'veo3.1-components')" class="model-option flex justify-between items-center px-3 py-2 rounded-lg cursor-pointer hover:bg-violet-50 dark:hover:bg-[#27272a] group" data-val="veo3.1-components">
                                <span class="text-xs font-bold">veo3.1-components</span>
                                <i class="fa-solid fa-check text-violet-500 text-xs opacity-0 check-icon"></i>
                            </div>
                            <div onclick="selectModel('veo3.1-pro', 'veo3.1-pro')" class="model-option flex justify-between items-center px-3 py-2 rounded-lg cursor-pointer hover:bg-violet-50 dark:hover:bg-[#27272a] group" data-val="veo3.1-pro">
                                <span class="text-xs font-bold">veo3.1-pro</span>
                                <i class="fa-solid fa-check text-violet-500 text-xs opacity-0 check-icon"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="space-y-3">
                    <label class="text-xs font-bold uppercase text-black-500">参考图片</label>
                    <div id="image-slots-container" class="grid gap-3"></div>
                    <input type="file" id="file-input" class="hidden" accept="image/*" onchange="handleImageUpload(event)">
                </div>

                <div class="space-y-2">
                    <label class="text-xs font-bold uppercase text-black-500">提示词</label>
                    <textarea id="prompt-input" class="w-full h-32 custom-input rounded-xl p-3 text-sm bg-gray-50 border border-gray-200 dark:bg-[#18181b] dark:border-[#27272a] dark:text-gray-200 placeholder-gray-400 resize-none font-mono" placeholder="描述想要生成的视频内容..."></textarea>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div class="flex items-center justify-between p-2 bg-gray-50 dark:bg-[#18181b] rounded-xl border border-gray-200 dark:border-[#27272a]">
                        <span class="text-[11px] font-bold">优化提示词</span>
                        <input type="checkbox" id="enhance-prompt" class="accent-violet-600 w-3.5 h-3.5 cursor-pointer">
                    </div>
                    <div class="flex items-center justify-between p-2 bg-gray-50 dark:bg-[#18181b] rounded-xl border border-gray-200 dark:border-[#27272a]">
                        <span class="text-[11px] font-bold">分辨率提升</span>
                        <input type="checkbox" id="upscale-res" class="accent-violet-600 w-3.5 h-3.5 cursor-pointer">
                    </div>
                </div>

                <div class="mt-auto space-y-4">
                    <div class="space-y-2">
                        <label class="text-xs font-bold uppercase text-gray-500">宽高比</label>
                        <div class="relative w-full" id="custom-ratio-dropdown">
                            <input type="hidden" id="ratio-input" value="16:9">
                            <div onclick="toggleDropdown(event, 'custom-ratio-dropdown', 'ratio-options', 'ratio-trigger')" id="ratio-trigger" class="w-full flex justify-between items-center bg-gray-50 dark:bg-[#18181b] border border-gray-200 dark:border-[#27272a] rounded-lg px-3 py-2.5 cursor-pointer hover:bg-gray-100 dark:hover:bg-[#27272a]">
                                <span id="current-ratio-text" class="text-sm font-bold">16:9 (横屏)</span>
                                <i class="fa-solid fa-chevron-down text-[10px] text-gray-500 dropdown-arrow"></i>
                            </div>
                            <div id="ratio-options" class="hidden absolute bottom-full left-0 mb-2 w-full bg-white dark:bg-[#18181b] border border-gray-200 dark:border-[#27272a] rounded-xl shadow-xl z-50 p-1">
                                <div onclick="selectRatio('16:9', '16:9 (横屏)')" class="ratio-option flex justify-between items-center px-3 py-2 rounded-lg cursor-pointer hover:bg-violet-50 dark:hover:bg-[#27272a] group" data-val="16:9">
                                    <span class="text-sm font-bold">16:9 (横屏)</span>
                                    <i class="fa-solid fa-check text-violet-500 text-xs opacity-100 check-icon-ratio"></i>
                                </div>
                                <div onclick="selectRatio('9:16', '9:16 (竖屏)')" class="ratio-option flex justify-between items-center px-3 py-2 rounded-lg cursor-pointer hover:bg-violet-50 dark:hover:bg-[#27272a] group" data-val="9:16">
                                    <span class="text-sm font-bold">9:16 (竖屏)</span>
                                    <i class="fa-solid fa-check text-violet-500 text-xs opacity-0 check-icon-ratio"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button onclick="submitTask()" id="generate-btn" class="w-full bg-gradient-to-r from-violet-600 to-indigo-600 hover:opacity-90 text-white font-bold py-3.5 rounded-xl transition transform active:scale-[0.98] flex items-center justify-center gap-2 shadow-lg shadow-purple-500/20">
                        <span>✨ 立即生成</span><i id="loading-icon" class="fa-solid fa-spinner fa-spin hidden"></i>
                    </button>
                </div>
            </div>
        </aside>

        <div id="resizer-x" class="resizer-x shrink-0"></div>

        <main class="flex-1 flex flex-col min-w-0 bg-white dark:bg-black transition-colors overflow-hidden">
            <div id="preview-section" style="height: 60%;" class="min-h-[200px] border-b border-gray-200 dark:border-[#27272a] bg-black relative flex">
                <div class="flex-1 flex items-center justify-center relative overflow-hidden bg-black">
                    <video id="main-player" class="w-full h-full object-contain" controls autoplay loop playsinline></video>
                    <div id="preview-placeholder" class="absolute inset-0 bg-gray-100 dark:bg-[#121214] flex flex-col items-center justify-center text-gray-400 z-10">
                        <i class="fa-solid fa-clapperboard text-4xl mb-3 opacity-20"></i>
                        <p class="text-sm font-medium">预览区</p>
                    </div>
                    <div id="preview-loading" class="absolute inset-0 bg-black/90 z-20 flex flex-col items-center justify-center text-white hidden">
                        <i class="fa-solid fa-circle-notch fa-spin text-4xl text-violet-500 mb-4"></i>
                        <p class="text-lg font-bold">生成中... <span id="loading-percent">0%</span></p>
                    </div>
                </div>
                <div id="detail-panel" class="w-[320px] bg-white dark:bg-[#0c0c0e] border-l border-gray-200 dark:border-[#27272a] flex flex-col shrink-0 hidden md:flex overflow-y-auto">
                    <div class="p-5 space-y-5">
                        <div class="flex items-center justify-between">
                            <div id="status-badge" class="px-2 py-0.5 rounded text-[10px] font-bold bg-gray-100 text-gray-500 uppercase">Waiting</div>
                            <span class="text-[9px] text-gray-400 font-mono truncate max-w-[180px] cursor-pointer hover:text-violet-500" id="detail-url" title="点击复制地址" onclick="copyDetailUrl()">-</span>
                        </div>
                        <div><p class="text-[10px] text-gray-400 font-bold uppercase mb-1">任务 ID</p>
                            <div class="flex items-center gap-2"><code class="text-[11px] font-mono text-gray-500 break-all" id="detail-id">---</code><button onclick="copyId()" class="text-violet-500 text-[10px] hover:underline shrink-0">复制</button></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-xs">
                            <div><p class="text-gray-400 mb-1 font-bold uppercase text-[9px]">耗时</p><p class="font-bold" id="detail-time">-</p></div>
                            <div><p class="text-gray-400 mb-1 font-bold uppercase text-[9px]">宽高比</p><p class="font-bold" id="detail-ratio">-</p></div>
                        </div>
                        <div><p class="text-[10px] text-gray-400 font-bold uppercase mb-2">提示词内容</p><div class="prompt-box text-[12px] max-h-40 overflow-y-auto select-text leading-relaxed" id="detail-prompt">(无)</div></div>
                    </div>
                    <div class="mt-auto p-5 border-t border-gray-100 dark:border-[#18181b]">
                        <button id="download-btn" onclick="downloadCurrentVideo()" class="w-full bg-black dark:bg-white text-white dark:text-black font-bold py-3 rounded-lg flex items-center justify-center gap-2 opacity-50 pointer-events-none transition hover:opacity-80"><i class="fa-solid fa-download"></i> 下载视频</button>
                    </div>
                </div>
            </div>

            <div id="resizer-y" class="resizer-y shrink-0"></div>

            <div id="list-section" class="flex-1 flex flex-col min-h-0 bg-white dark:bg-[#0c0c0e]">
                <div class="h-10 border-b border-gray-200 dark:border-[#27272a] flex items-center justify-between px-6 shrink-0 bg-gray-50/50 dark:bg-[#121214]">
                    <div class="flex items-center gap-2"><input type="checkbox" id="select-all" class="accent-violet-500 cursor-pointer" onchange="toggleSelectAll()"><span class="text-xs font-bold text-gray-500 uppercase tracking-wider" id="list-header-text">任务列表</span></div>
                    <div class="flex gap-4">
                        <div id="batch-actions" class="hidden flex gap-2"><button onclick="batchDelete()" class="text-xs text-red-500 hover:text-red-600 flex items-center gap-1 bg-red-50 dark:bg-red-900/20 px-2 py-0.5 rounded transition"><i class="fa-solid fa-trash"></i> 删除选中</button></div>
                        <div class="w-[1px] h-4 bg-gray-300 dark:bg-gray-700"></div>
                        <button onclick="checkAllTasksStatus()" class="text-xs text-violet-500 hover:text-violet-600 transition flex items-center gap-1"><i class="fa-solid fa-rotate"></i> 刷新</button>
                        <button onclick="clearHistory()" class="text-xs text-gray-400 hover:text-red-500 transition flex items-center gap-1"><i class="fa-solid fa-trash"></i> 清空</button>
                    </div>
                </div>
                <div id="task-list" class="flex-1 overflow-y-auto p-0"></div>
            </div>
        </main>
    </div>

    <div id="settings-modal" class="fixed inset-0 bg-black/60 z-[100] hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white dark:bg-[#18181b] p-6 rounded-2xl w-[400px] shadow-2xl border border-gray-200 dark:border-[#27272a]">
            <div class="flex justify-between items-center mb-6"><h3 class="text-lg font-bold dark:text-white">API 配置</h3><button onclick="closeSettings()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark"></i></button></div>
            <div class="space-y-4">
                <div><label class="block text-xs font-bold text-gray-500 mb-2 uppercase">API 地址</label><input type="text" id="setting-url" class="w-full bg-gray-50 dark:bg-[#0c0c0e] border border-gray-200 dark:border-[#27272a] rounded-xl p-3 text-sm font-mono focus:border-violet-500 outline-none" placeholder="https://api.bltcy.ai"><div class="flex gap-2 mt-2"><button onclick="fillApiUrl('https://ai.t8star.cn')" class="flex-1 py-1.5 rounded-lg bg-pink-50 dark:bg-pink-900/20 border border-pink-200 dark:border-pink-800 text-[10px] font-bold text-pink-600">贞贞 ai.t8star.cn</button><button onclick="fillApiUrl('https://api.bltcy.ai')" class="flex-1 py-1.5 rounded-lg bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 text-[10px] font-bold text-blue-600">柏拉图 api.bltcy.ai</button></div></div>
                <div><label class="block text-xs font-bold text-gray-500 mb-2 uppercase">API Key</label><input type="password" id="setting-key" class="w-full bg-gray-50 dark:bg-[#0c0c0e] border border-gray-200 dark:border-[#27272a] rounded-xl p-3 text-sm font-mono focus:border-violet-500 outline-none" placeholder="sk-..."></div>
                <button onclick="saveSettings()" class="w-full bg-violet-600 hover:bg-violet-700 text-white font-bold py-3 rounded-xl transition mt-4">保存配置</button>
            </div>
        </div>
    </div>

    <script>
        let taskList = []; let uploadedImages = {}; let activeTaskId = null; let currentActiveSlot = null; let isResizingX = false, isResizingY = false;

        function initApp() { loadSettings(); loadHistory(); renderSlots(); setupResizers(); checkAllTasksStatus(); startPolling(); }

        function toggleDropdown(event, containerId, optionsId, triggerId) { if(event) event.stopPropagation(); const options = document.getElementById(optionsId), trigger = document.getElementById(triggerId); document.getElementById(containerId).classList.toggle('dropdown-open'); options.classList.toggle('hidden'); if (!options.classList.contains('hidden')) trigger.classList.add('glow-effect'); else trigger.classList.remove('glow-effect'); }
        function selectModel(val, text) { document.getElementById('model-input').value = val; document.getElementById('current-model-text').innerText = text; document.querySelectorAll('.model-option').forEach(opt => { const isSelected = opt.dataset.val === val; opt.querySelector('.check-icon').classList.toggle('opacity-100', isSelected); opt.querySelector('.check-icon').classList.toggle('opacity-0', !isSelected); opt.classList.toggle('bg-violet-50', isSelected); opt.classList.toggle('dark:bg-[#27272a]', isSelected); }); uploadedImages = {}; renderSlots(); toggleDropdown(null, 'custom-model-dropdown', 'model-options', 'model-trigger'); }
        function selectRatio(val, text) { document.getElementById('ratio-input').value = val; document.getElementById('current-ratio-text').innerText = text; document.querySelectorAll('.ratio-option').forEach(opt => { const isSelected = opt.dataset.val === val; opt.querySelector('.check-icon-ratio').classList.toggle('opacity-100', isSelected); opt.querySelector('.check-icon-ratio').classList.toggle('opacity-0', !isSelected); }); toggleDropdown(null, 'custom-ratio-dropdown', 'ratio-options', 'ratio-trigger'); }
        function closeDropdownOnClickOutside(event) { ['custom-model-dropdown', 'custom-ratio-dropdown'].forEach(id => { const container = document.getElementById(id); if (container && !container.contains(event.target)) { container.classList.remove('dropdown-open'); const options = container.querySelector('div[id$="-options"]'), trigger = container.querySelector('div[id$="-trigger"]'); if(options) options.classList.add('hidden'); if(trigger) trigger.classList.remove('glow-effect'); } }); }

        function renderSlots() {
            const container = document.getElementById('image-slots-container'), model = document.getElementById('model-input').value;
            container.innerHTML = ''; let slots = model === 'veo3.1-components' ? ['图片 1', '图片 2', '图片 3'] : ['首帧', '尾帧'];
            container.className = model === 'veo3.1-components' ? "grid grid-cols-3 gap-3" : "grid grid-cols-2 gap-3";
            slots.forEach((label, idx) => {
                const slotId = `slot-${idx}`, div = document.createElement('div');
                div.className = "relative aspect-video rounded-xl border border-dashed border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-[#18181b] cursor-pointer group flex flex-col items-center justify-center overflow-hidden transition-all hover:border-violet-400";
                div.onclick = () => { currentActiveSlot = slotId; document.getElementById('file-input').click(); };
                if (uploadedImages[slotId]) { 
                    div.innerHTML = `
                        <img src="${uploadedImages[slotId]}" class="w-full h-full object-cover">
                        <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition flex items-center justify-center">
                            <i class="fa-solid fa-rotate text-white"></i>
                        </div>
                        <div onclick="removeImage('${slotId}', event)" class="absolute top-1 right-1 w-5 h-5 bg-red-500/80 hover:bg-red-500 text-white rounded-full flex items-center justify-center z-20 opacity-0 group-hover:opacity-100 transition shadow-sm" title="删除图片">
                            <i class="fa-solid fa-xmark text-[10px]"></i>
                        </div>`; 
                } 
                else { div.innerHTML = `<i class="fa-solid fa-plus text-gray-300 mb-1"></i><span class="text-[9px] font-bold text-gray-400 uppercase">${label}</span>`; }
                container.appendChild(div);
            });
        }

        // 新增删除图片函数
        function removeImage(slotId, e) {
            if (e) e.stopPropagation();
            delete uploadedImages[slotId];
            renderSlots();
        }

        function handleImageUpload(e) { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (evt) => { uploadedImages[currentActiveSlot] = evt.target.result; renderSlots(); }; reader.readAsDataURL(file); }

        function renderTaskList() {
            const container = document.getElementById('task-list'); if (taskList.length === 0) { container.innerHTML = '<div id="empty-state" class="h-full flex flex-col items-center justify-center text-gray-400 opacity-60 pb-10"><i class="fa-solid fa-inbox text-4xl mb-3"></i><p class="text-xs">暂无记录</p></div>'; updateListHeader(); return; }
            container.innerHTML = '';
            taskList.forEach(task => {
                const isActive = activeTaskId === task.id, div = document.createElement('div');
                div.className = `task-item flex items-center gap-4 px-6 py-3 border-b border-gray-100 dark:border-[#27272a] cursor-pointer transition-colors hover:bg-gray-50 dark:hover:bg-[#121214] ${isActive ? 'selected bg-violet-50/50 dark:bg-violet-900/10 border-l-4 border-l-violet-500' : 'border-l-4 border-l-transparent'}`;
                div.onclick = () => updatePreview(task.id);
                let thumbHtml = (task.status === 'SUCCESS' && task.videoUrl) ? `<div class="w-16 h-10 bg-black rounded overflow-hidden relative shrink-0 shadow-sm group"><video src="${task.videoUrl}" class="w-full h-full object-cover" preload="metadata" onmouseover="this.play()" onmouseout="this.pause()" muted></video></div>` : `<div class="w-16 h-10 bg-gray-100 dark:bg-[#27272a] rounded flex items-center justify-center shrink-0"><i class="fa-solid ${task.status==='FAILURE'?'fa-triangle-exclamation text-red-400':'fa-spinner fa-spin text-gray-400'}"></i></div>`;
                let statusIcon = task.status === 'SUCCESS' ? '<i class="fa-solid fa-check text-green-500 text-xs"></i>' : (task.status === 'FAILURE' ? '<i class="fa-solid fa-xmark text-red-500 text-xs"></i>' : `<span class="text-blue-500 font-bold text-[10px]">${task.progress||"0%"}</span>`);
                div.innerHTML = `<div class="shrink-0 flex items-center justify-center" onclick="event.stopPropagation()"><input type="checkbox" class="task-checkbox accent-violet-500 w-4 h-4 cursor-pointer" value="${task.id}" onchange="updateListHeader()" onclick="event.stopPropagation()"></div>${thumbHtml}<div class="flex-1 min-w-0 flex flex-col justify-center gap-1"><div class="flex items-center justify-between"><span class="text-[10px] font-mono text-gray-400">ID: ${task.id.slice(0,8)}...</span><span class="text-[9px] text-gray-400">${new Date(task.startTime).toLocaleTimeString()}</span></div><p class="text-xs font-medium truncate">${task.prompt}</p></div><div class="flex items-center gap-3">${statusIcon}<button onclick="event.stopPropagation(); downloadSingleTask('${task.id}')" class="text-gray-400 hover:text-violet-500"><i class="fa-solid fa-download"></i></button><button onclick="event.stopPropagation(); deleteTask('${task.id}')" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-trash"></i></button></div>`;
                container.appendChild(div);
            });
            updateListHeader();
        }

        function toggleSelectAll() { const master = document.getElementById('select-all'); document.querySelectorAll('.task-checkbox').forEach(cb => cb.checked = master.checked); updateListHeader(); }
        function updateListHeader() { const boxes = document.querySelectorAll('.task-checkbox'), checked = document.querySelectorAll('.task-checkbox:checked'), header = document.getElementById('list-header-text'), actions = document.getElementById('batch-actions'); header.innerText = checked.length > 0 ? `已选 ${checked.length} 项` : `任务列表 (${taskList.length})`; header.classList.toggle('text-violet-500', checked.length > 0); actions.classList.toggle('hidden', checked.length === 0); if(boxes.length > 0) document.getElementById('select-all').checked = (checked.length === boxes.length); }
        function batchDelete() { const checked = document.querySelectorAll('.task-checkbox:checked'); if(checked.length === 0) return; if(!confirm(`删除选中的 ${checked.length} 项？`)) return; const ids = Array.from(checked).map(cb => cb.value); taskList = taskList.filter(t => !ids.includes(t.id)); saveHistory(); renderTaskList(); if(ids.includes(activeTaskId)) { activeTaskId = null; updatePreview(null); } }
        function deleteTask(id) { if(!confirm("删除此任务？")) return; taskList = taskList.filter(t => t.id !== id); saveHistory(); renderTaskList(); if(activeTaskId === id) { activeTaskId = null; updatePreview(null); } }
        function downloadSingleTask(id) { const task = taskList.find(t => t.id === id); if(task && task.videoUrl) downloadCurrentVideo(task.videoUrl, id); else alert("视频未就绪"); }

        async function submitTask() {
            const key = localStorage.getItem('veo_api_key'), url = localStorage.getItem('veo_api_url'); if (!key) { openSettings(); return; }
            const prompt = document.getElementById('prompt-input').value.trim(); if (!prompt) { alert("请输入提示词"); return; }
            const btn = document.getElementById('generate-btn'), icon = document.getElementById('loading-icon'); btn.disabled = true; icon.classList.remove('hidden');
            const payload = { model: document.getElementById('model-input').value, prompt, aspect_ratio: document.getElementById('ratio-input').value, images: Object.values(uploadedImages), enhance_prompt: document.getElementById('enhance-prompt').checked, enable_upsample: document.getElementById('upscale-res').checked };
            try {
                const res = await fetch(`${url}/v2/videos/generations`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` }, body: JSON.stringify(payload) });
                const data = await res.json(); if (!res.ok) throw new Error(data.error?.message || "提交失败");
                const taskId = data.task_id || data.id || (data.data && data.data.id);
                taskList.unshift({ id: taskId, prompt, model: payload.model, ratio: payload.aspect_ratio, status: 'NOT_START', startTime: Date.now(), progress: "0%" });
                saveHistory(); renderTaskList(); updatePreview(taskId);
            } catch (e) { alert("错误: " + e.message); } finally { btn.disabled = false; icon.classList.add('hidden'); }
        }

        async function checkStatus(id) {
            const task = taskList.find(t => t.id === id); if (!task || ['SUCCESS', 'FAILURE'].includes(task.status)) return;
            const key = localStorage.getItem('veo_api_key'), url = localStorage.getItem('veo_api_url');
            try {
                const res = await fetch(`${url}/v2/videos/generations/${id}`, { headers: { 'Authorization': `Bearer ${key}` } });
                const data = await res.json(), status = data.status || (data.data && data.data.status);
                task.status = status ? status.toUpperCase() : 'IN_PROGRESS';
                task.progress = data.progress || (task.status === 'SUCCESS' ? "100%" : (data.data && data.data.progress ? data.data.progress : "0%"));
                if (data.data && data.data.output) task.videoUrl = data.data.output; else if (data.output) task.videoUrl = data.output;
                if(task.status === 'SUCCESS') task.finishTime = Date.now();
                saveHistory(); renderTaskList(); if (activeTaskId === id) updatePreview(id);
            } catch (e) { console.error(e); }
        }

        function updatePreview(id) {
            activeTaskId = id; const task = taskList.find(t => t.id === id), player = document.getElementById('main-player'), placeholder = document.getElementById('preview-placeholder'), loading = document.getElementById('preview-loading'), badge = document.getElementById('status-badge'), dlBtn = document.getElementById('download-btn'), detail = document.getElementById('detail-panel');
            if (!task) { if(detail) detail.classList.add('hidden'); player.classList.add('hidden'); placeholder.classList.remove('hidden'); return; }
            if(detail) detail.classList.remove('hidden'); renderTaskList();
            document.getElementById('detail-id').innerText = task.id;
            document.getElementById('detail-url').innerText = task.videoUrl || "生成中...";
            document.getElementById('detail-prompt').innerText = task.prompt;
            document.getElementById('detail-ratio').innerText = task.ratio;
            badge.innerText = task.status; badge.className = `px-2 py-0.5 rounded text-[10px] font-bold uppercase ${task.status === 'SUCCESS' ? 'bg-green-100 text-green-600' : 'bg-blue-100 text-blue-600'}`;
            if (task.status === 'SUCCESS' && task.videoUrl) { player.src = task.videoUrl; player.classList.remove('hidden'); placeholder.classList.add('hidden'); loading.classList.add('hidden'); document.getElementById('detail-time').innerText = task.finishTime ? Math.floor((task.finishTime - task.startTime)/1000) + 's' : '-'; dlBtn.classList.remove('opacity-50', 'pointer-events-none'); }
            else if (task.status === 'FAILURE') { player.classList.add('hidden'); placeholder.classList.remove('hidden'); loading.classList.add('hidden'); dlBtn.classList.add('opacity-50', 'pointer-events-none'); }
            else {
                player.classList.add('hidden'); placeholder.classList.add('hidden'); loading.classList.remove('hidden'); 
                document.getElementById('loading-percent').innerText = task.progress || "0%"; 
                document.getElementById('detail-time').innerText = Math.floor((Date.now() - task.startTime)/1000) + 's'; dlBtn.classList.add('opacity-50', 'pointer-events-none');
            }
        }

        function copyId() { const id = document.getElementById('detail-id').innerText; if(id !== '---') { navigator.clipboard.writeText(id); alert("ID已复制"); } }
        function copyDetailUrl() { const url = document.getElementById('detail-url').innerText; if(url && url.startsWith('http')) { navigator.clipboard.writeText(url); alert("链接已复制"); } }
        async function downloadCurrentVideo(url, id) { const vUrl = url || taskList.find(t => t.id === activeTaskId)?.videoUrl; if (!vUrl) return; try { const res = await fetch(vUrl); const blob = await res.blob(), bUrl = window.URL.createObjectURL(blob), a = document.createElement('a'); a.href = bUrl; a.download = `veo_${id||activeTaskId}.mp4`; a.click(); } catch (e) { window.open(vUrl, '_blank'); } }
        function startPolling() { setInterval(() => taskList.forEach(t => { if(!['SUCCESS', 'FAILURE'].includes(t.status)) checkStatus(t.id); }), 5000); }
        async function checkAllTasksStatus() { taskList.forEach(t => { if(!['SUCCESS', 'FAILURE'].includes(t.status)) checkStatus(t.id); }); }
        function saveHistory() { localStorage.setItem('veo_history_v1', JSON.stringify(taskList)); }
        function loadHistory() { const saved = localStorage.getItem('veo_history_v1'); if(saved) { taskList = JSON.parse(saved); renderTaskList(); } }
        function clearHistory() { if(confirm("清空历史？")) { taskList = []; saveHistory(); renderTaskList(); activeTaskId = null; updatePreview(null); } }
        function fillApiUrl(url) { document.getElementById('setting-url').value = url; }
        function openSettings() { document.getElementById('settings-modal').classList.remove('hidden'); }
        function closeSettings() { document.getElementById('settings-modal').classList.add('hidden'); }
        function saveSettings() { localStorage.setItem('veo_api_url', document.getElementById('setting-url').value.trim()); localStorage.setItem('veo_api_key', document.getElementById('setting-key').value.trim()); updateApiDisplay(localStorage.getItem('veo_api_url')); closeSettings(); }
        function loadSettings() { document.getElementById('setting-url').value = localStorage.getItem('veo_api_url') || 'https://api.bltcy.ai'; document.getElementById('setting-key').value = localStorage.getItem('veo_api_key') || ''; updateApiDisplay(document.getElementById('setting-url').value); }
        function updateApiDisplay(url) { try { document.getElementById('current-api-display').innerText = "当前: " + new URL(url).hostname; } catch(e) {} }
        function toggleTheme() { document.documentElement.classList.toggle('dark'); }
        
        function setupResizers() {
            const rx = document.getElementById('resizer-x'), ry = document.getElementById('resizer-y'), lp = document.getElementById('left-panel'), ps = document.getElementById('preview-section');
            const stop = () => { isResizingX = false; isResizingY = false; document.body.classList.remove('no-select'); if(rx) rx.classList.remove('active'); if(ry) ry.classList.remove('active'); };
            if(rx) rx.addEventListener('mousedown', (e) => { e.preventDefault(); isResizingX = true; document.body.classList.add('no-select'); rx.classList.add('active'); });
            if(ry) ry.addEventListener('mousedown', (e) => { e.preventDefault(); isResizingY = true; document.body.classList.add('no-select'); ry.classList.add('active'); });
            window.addEventListener('mousemove', (e) => {
                if (isResizingX) { let w = e.clientX; if (w > 280 && w < 600) lp.style.width = w + 'px'; }
                if (isResizingY) { let h = e.clientY - ps.getBoundingClientRect().top; if (h > 200 && h < window.innerHeight - 300) ps.style.height = h + 'px'; }
            });
            window.addEventListener('mouseup', stop);
            window.addEventListener('mouseleave', stop);
        }
    </script>
</body>
</html>